@using BudgetDashboard.Data
@using BudgetDashboard.Data.Entities
@using BudgetDashboard.Web.Components.Components
@using Microsoft.EntityFrameworkCore
@using System.Globalization
@inject BudgetContext Db

<Offcanvas @ref="BudgetCanvas" Position="start" Size="500px" OnHidden="HandleOffcanvasClosed">
    <HeaderContent>
        <div class="d-flex align-items-center gap-2 editable-field-container">
            <i class="fas fa-piggy-bank"/>
            <InlineEditor 
                TContext="Budget"
                @ref="NameEditor"
                Context="@Budget"
                FieldContent="@(Budget?.Name ?? string.Empty)"
                FieldPlaceholder="Enter budget name..."
                OnSaved="SaveNameAsync">
                <TextContent Context="StartEditingAction">
                    <h5 class="rounded m-0 fw-bolder d-flex align-items-center editable-title" 
                        @onclick="StartEditingAction">@Budget?.Name</h5>
                </TextContent>
            </InlineEditor>
        </div>
    </HeaderContent>

    <BodyContent>
        @if (Budget is not null)
        {
            <div class="table-responsive">
                <table class="table align-middle">
                    <thead>
                        <tr>
                            <th style="width: 50%">Name</th>
                            <th style="width: 25%">Amount (â‚¬)</th>
                            <th style="width: 15%">Optional</th>
                            <th style="width: 10%"></th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var item in Budget.Items)
                        {
                            <tr>
                                <td class="editable-field-container">
                                    <InlineEditor TContext="BudgetItem"
                                                  Context="@item"
                                                  FieldContent="@item.Name"
                                                  FieldPlaceholder="Enter item name..."
                                                  OnSaved="SaveItemNameAsync">
                                        <TextContent Context="StartEditingAction">
                                            <span class="rounded m-0 d-flex align-items-center editable-title"
                                                  @onclick="StartEditingAction">@item.Name</span>
                                        </TextContent>
                                    </InlineEditor>
                                </td>
                                <td class="editable-field-container">
                                    <InlineEditor TContext="BudgetItem"
                                                  Context="@item"
                                                  FieldContent="@item.EstimatedAmount.ToString("G", CultureInfo.CurrentCulture)"
                                                  FieldPlaceholder="Enter item amount..."
                                                  OnSaved="SaveItemAmountAsync">
                                        <TextContent Context="StartEditingAction">
                                            <span class="rounded m-0 d-flex align-items-center editable-title"
                                                  @onclick="StartEditingAction">@item.EstimatedAmount.ToString("N2", CultureInfo.CurrentCulture)</span>
                                        </TextContent>
                                    </InlineEditor>
                                </td>
                                <td class="text-center">
                                    <input type="checkbox"
                                           checked="@item.IsOptional"
                                           @onchange="(e) => HandleCheckboxChange(e, item)" />
                                </td>
                                <td class="text-end">
                                    <button class="btn btn-sm btn-outline-danger"
                                            title="Delete item"
                                            @onclick="() => DeleteItemAsync(item)">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
            <button class="btn btn-primary d-flex align-items-center me-3 gap-2"
                    title="@(Budget?.Id == 0 ? "Enter a name first" : "Add new item")"
                    disabled="@(Budget?.Id == 0)"
                    @onclick="AddItemAsync">
                <i class="fas fa-plus"></i>
                <span>Add</span>
            </button>
        }
    </BodyContent>
</Offcanvas>

@code {
    [Parameter] public Budget? Budget { get; set; }
    [Parameter] public EventCallback OnSaved { get; set; }

    private Offcanvas? BudgetCanvas { get; set; }
    private InlineEditor<Budget>? NameEditor;

    public async Task ShowAsync(Budget? budget = null)
    {
        if (budget is null)
        {
            Budget = new Budget
            {
                Name = "",
                CreatedOn = DateOnly.FromDateTime(DateTime.Now),
                Items = new List<BudgetItem>()
            };
        }
        else
        {
            Budget = budget;
        }

        if (BudgetCanvas is not null)
        {
            await BudgetCanvas.Show();
            if (budget is null)
            {
                NameEditor?.BeginEdit();
            }
        }
    }

    private async Task HandleOffcanvasClosed()
    {
        Budget = null;
        NameEditor?.StopEdit();
        await InvokeAsync(StateHasChanged);
    }

    private async Task SaveNameAsync((string NewName, Budget? Budget) args)
    {
        var (newName, budget) = args;
        if (budget is null || newName == budget.Name)
            return;

        budget.Name = newName;
        Db.Budgets.Update(budget);
        await SaveAndNotifyAsync();
    }

    private async Task SaveItemNameAsync((string NewName, BudgetItem? Item) args)
    {
        var (newName, item) = args;
        if (item is null || newName == item.Name)
            return;

        item.Name = newName;
        Db.BudgetItems.Update(item);
        await SaveAndNotifyAsync();
    }

    private async Task SaveItemAmountAsync((string NewAmountString, BudgetItem? Item) args)
    {
        var (newAmountString, item) = args;
        if (item is null)
            return;

        // Parse using current culture so , or . both work for the user's locale
        if (decimal.TryParse(newAmountString, NumberStyles.Number, CultureInfo.CurrentCulture, out var newAmount)
            && newAmount != item.EstimatedAmount)
        {
            item.EstimatedAmount = newAmount;
            Db.BudgetItems.Update(item);
            await SaveAndNotifyAsync();
        }
    }

    private async Task HandleCheckboxChange(ChangeEventArgs e, BudgetItem item)
    {
        var newValue = e.Value is bool b && b;
        await ToggleOptionalAsync(item, newValue);
    }

    private async Task ToggleOptionalAsync(BudgetItem item, bool newValue)
    {
        item.IsOptional = newValue;
        Db.BudgetItems.Update(item);
        await SaveAndNotifyAsync();
    }

    private async Task AddItemAsync()
    {
        if (Budget is null)
            return;

        // Persist the budget if new
        if (Budget.Id == 0)
        {
            return;
            @* Db.Budgets.Add(Budget);
            await Db.SaveChangesAsync(); *@
        }

        var newItem = new BudgetItem
        {
            Name = "New item",
            EstimatedAmount = 0m,
            IsOptional = false,
            BudgetId = Budget.Id
        };

        Budget.Items.Add(newItem);
        Db.BudgetItems.Add(newItem);

        await Db.SaveChangesAsync();
        await OnSaved.InvokeAsync();
    }

    private async Task DeleteItemAsync(BudgetItem? item)
    {
        if (item is null)
            return;

        Db.BudgetItems.Remove(item);
        await Db.SaveChangesAsync();

        Budget?.Items.Remove(item);
        await SaveAndNotifyAsync();
    }

    private async Task SaveAndNotifyAsync()
    {
        await Db.SaveChangesAsync();
        await OnSaved.InvokeAsync();
    }
}
