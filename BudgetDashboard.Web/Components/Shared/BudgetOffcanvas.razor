@using BudgetDashboard.Data
@using BudgetDashboard.Data.Entities
@using BudgetDashboard.Data.Extensions
@using BudgetDashboard.Web.Components.Components
@using Microsoft.EntityFrameworkCore
@using Microsoft.AspNetCore.Components.Authorization
@using System.Security.Claims
@using System.Globalization
@inject BudgetContext Db
@inject AuthenticationStateProvider AuthStateProvider

<Offcanvas @ref="BudgetCanvas" Position="start" Size="600px" OnHidden="HandleOffcanvasClosed">
    <HeaderContent>
        <div class="d-flex align-items-center gap-2 editable-field-container">
            <i class="fas fa-piggy-bank"/>
            <InlineEditor 
                TContext="Budget"
                @ref="NameEditor"
                Context="@Budget"
                FieldContent="@(Budget?.Name ?? string.Empty)"
                FieldPlaceholder="Enter budget name..."
                InputStyle="min-width: 300px;"
                OnSaved="SaveNameAsync">
                <TextContent>
                    <h5 class="border rounded m-0 fw-bolder d-flex align-items-center text-nowrap editable-title">@Budget?.Name</h5>
                </TextContent>
            </InlineEditor>
        </div>
    </HeaderContent>
    <BodyContent>
        @if (Budget is not null)
        {
            <div class="container">
                <div class="row d-flex align-items-center budget-grid-header">
                    <div class="col-5">NAME</div>
                    <div class="col-4">AMOUNT</div>
                    <div class="col-2 text-center">OPTIONAL</div>
                    <div class="col-1 text-end p-0">
                        <button class="btn btn-sm btn-outline-primary"
                                title="@(Budget?.Id == 0 ? "Enter a name first" : "Add new item")"
                                disabled="@(Budget?.Id == 0)"
                                @onclick="AddItemAsync">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                </div>

                @foreach (var item in Budget.Items)
                {
                    <div class="row d-flex align-items-center budget-grid-row">
                        <div class="col-5 editable-field-container">
                            <InlineEditor TContext="BudgetItem"
                                        Context="@item"
                                        FieldContent="@item.Name"
                                        FieldPlaceholder="Enter item name..."
                                        InputStyle="min-width: 150px;"
                                        OnSaved="SaveItemNameAsync">
                                <TextContent>
                                    <span class="border rounded py-1 m-0 d-flex align-items-center text-nowrap editable-title">@item.Name</span>
                                </TextContent>
                            </InlineEditor>
                        </div>

                        <div class="col-4 editable-field-container">
                            <InlineEditor TContext="BudgetItem"
                                        Context="@item"
                                        FieldContent="@item.EstimatedAmount.ToString("G", CultureInfo.CurrentCulture)"
                                        FieldPlaceholder="Enter item amount..."
                                        InputStyle="min-width: 100px;"
                                        OnSaved="SaveItemAmountAsync">
                                <TextContent>
                                    <span class="border rounded py-1 m-0 d-flex align-items-center text-nowrap editable-title">â‚¬ @item.EstimatedAmount.ToString("N2", CultureInfo.CurrentCulture)</span>
                                </TextContent>
                            </InlineEditor>
                        </div>

                        <div class="col-2 text-center">
                            <input type="checkbox"
                                checked="@item.IsOptional"
                                @onchange="(e) => HandleCheckboxChange(e, item)" />
                        </div>

                        <div class="col-1 text-end p-0">
                            <button class="btn btn-sm btn-outline-danger"
                                    title="Delete item"
                                    @onclick="() => DeleteItemAsync(item)">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                }
            </div>
            
            <hr class="my-4" />

            <div class="d-flex justify-content-end gap-2">
                <button class="btn btn-secondary d-flex align-items-center gap-2"
                        title="Clone this budget"
                        @onclick="CloneBudgetAsync">
                    <i class="fas fa-clone"></i>
                    <span>Clone</span>
                </button>

                <button class="btn btn-danger d-flex align-items-center gap-2"
                        title="Delete this budget"
                        @onclick="DeleteBudgetAsync">
                    <i class="fas fa-trash"></i>
                    <span>Delete</span>
                </button>
            </div>
        }
    </BodyContent>
</Offcanvas>

@code {
    [Parameter] public Budget? Budget { get; set; }
    [Parameter] public EventCallback OnSaved { get; set; }

    private Offcanvas? BudgetCanvas { get; set; }
    private InlineEditor<Budget>? NameEditor;
    private string? CurrentUserId;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        CurrentUserId = authState.User.FindFirstValue(ClaimTypes.NameIdentifier);
    }

    public async Task ShowAsync(Budget? budget = null)
    {
        if (budget is null)
        {
            Budget = new Budget
            {
                Name = "",
                CreatedOn = DateOnly.FromDateTime(DateTime.Now),
                Items = new List<BudgetItem>(),
                UserId = CurrentUserId // associate new budget with current user
            };
        }
        else
        {
            // Ensure this budget belongs to the current user
            if (budget.UserId != CurrentUserId)
                return; // optionally show a message instead

            Budget = budget;
        }

        if (BudgetCanvas is not null)
        {
            await BudgetCanvas.Show();
            if (budget is null)
            {
                NameEditor?.BeginEdit();
            }
        }
    }

    private async Task HandleOffcanvasClosed()
    {
        Budget = null;
        NameEditor?.StopEdit();
        await InvokeAsync(StateHasChanged);
    }

    private async Task SaveNameAsync((string NewName, Budget? Budget) args)
    {
        var (newName, budget) = args;
        if (budget is null || newName == budget.Name)
            return;

        budget.Name = newName;
        Db.Budgets.Update(budget);
        await SaveAndNotifyAsync();
    }

    private async Task SaveItemNameAsync((string NewName, BudgetItem? Item) args)
    {
        var (newName, item) = args;
        if (item is null || newName == item.Name)
            return;

        item.Name = newName;
        Db.BudgetItems.Update(item);
        await SaveAndNotifyAsync();
    }

    private async Task SaveItemAmountAsync((string NewAmountString, BudgetItem? Item) args)
    {
        var (newAmountString, item) = args;
        if (item is null)
            return;

        if (decimal.TryParse(newAmountString, NumberStyles.Number, CultureInfo.CurrentCulture, out var newAmount)
            && newAmount != item.EstimatedAmount)
        {
            item.EstimatedAmount = newAmount;
            Db.BudgetItems.Update(item);
            await SaveAndNotifyAsync();
        }
    }

    private async Task HandleCheckboxChange(ChangeEventArgs e, BudgetItem item)
    {
        var newValue = e.Value is bool b && b;
        await ToggleOptionalAsync(item, newValue);
    }

    private async Task ToggleOptionalAsync(BudgetItem item, bool newValue)
    {
        item.IsOptional = newValue;
        Db.BudgetItems.Update(item);
        await SaveAndNotifyAsync();
    }

    private async Task AddItemAsync()
    {
        if (Budget is null || Budget.Id == 0)
            return;

        var newItem = new BudgetItem
        {
            Name = "New item",
            EstimatedAmount = 0m,
            IsOptional = false,
            BudgetId = Budget.Id
        };

        Budget.Items.Add(newItem);
        Db.BudgetItems.Add(newItem);

        await Db.SaveChangesAsync();
        await OnSaved.InvokeAsync();
    }

    private async Task DeleteItemAsync(BudgetItem? item)
    {
        if (item is null)
            return;

        Db.BudgetItems.Remove(item);
        await Db.SaveChangesAsync();

        Budget?.Items.Remove(item);
        await SaveAndNotifyAsync();
    }
    
    private async Task CloneBudgetAsync()
    {
        if (Budget is null)
            return;

        var cloned = new Budget
        {
            Name = $"{Budget.Name} (Copy)",
            CreatedOn = DateOnly.FromDateTime(DateTime.Now),
            Items = Budget.Items.Select(i => new BudgetItem
            {
                Name = i.Name,
                EstimatedAmount = i.EstimatedAmount,
                IsOptional = i.IsOptional
            }).ToList(),
            UserId = CurrentUserId
        };

        Db.Budgets.Add(cloned);
        await Db.SaveChangesAsync();

        await BudgetCanvas!.Hide();
        await OnSaved.InvokeAsync();
    }

    private async Task DeleteBudgetAsync()
    {
        if (Budget is null)
            return;

        // Optional safety check
        if (Budget.UserId != CurrentUserId)
            return;

        Db.Budgets.Remove(Budget);
        await Db.SaveChangesAsync();

        await BudgetCanvas!.Hide();
        await OnSaved.InvokeAsync();
    }

    private async Task SaveAndNotifyAsync()
    {
        await Db.SaveChangesAsync();
        await OnSaved.InvokeAsync();
    }
}
