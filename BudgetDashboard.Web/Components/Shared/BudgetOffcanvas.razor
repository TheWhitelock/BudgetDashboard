@using BudgetDashboard.Data
@using BudgetDashboard.Data.Entities
@using BudgetDashboard.Web.Components.Components
@using Microsoft.EntityFrameworkCore
@inject BudgetContext Db

<Offcanvas @ref="BudgetCanvas" Position="start" Size="500px" OnHidden="HandleOffcanvasClosed">
    <HeaderContent>
        <div class="d-flex align-items-center gap-2 editable-field-container">
            <i class="fas fa-piggy-bank"/>
            <InlineEditor 
                @ref="NameEditor"
                FieldContent="@WorkingBudget.Name"
                FieldPlaceholder="Enter budget name..."
                OnSaved="SaveName">
                <TextContent Context="StartEditingAction">
                    <h5 class="border rounded border-white m-0 p-1 fw-bolder d-flex align-items-center editable-title" 
                        @onclick="StartEditingAction">@WorkingBudget.Name</h5>
                </TextContent>
            </InlineEditor>
        </div>
    </HeaderContent>

    <BodyContent>
        <div class="table-responsive">
            <table class="table align-middle">
                <thead>
                    <tr>
                        <th style="width: 50%">Name</th>
                        <th style="width: 25%">Amount (â‚¬)</th>
                        <th style="width: 15%">Optional</th>
                        <th style="width: 10%"></th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var item in WorkingBudget.Items)
                    {
                        <tr>
                            <td class="editable-field-container">
                                <InlineEditor
                                    FieldContent="@item.Name"
                                    FieldPlaceholder="Enter item name..."
                                    OnSaved="SaveItemName">
                                    <TextContent Context="StartEditingAction">
                                        <span class="rounded m-0 d-flex align-items-center editable-title" 
                                            @onclick="StartEditingAction">@item.Name</span>
                                    </TextContent>
                                </InlineEditor>
                            </td>
                            <td>
                                @if (EditingItem == item && EditingField == "Amount")
                                {
                                    <input type="number"
                                           step="0.01"
                                           @bind="EditableItemAmount"
                                           @bind:event="oninput"
                                           @onblur="() => SaveItem(item)"
                                           @onkeydown="(e) => HandleItemKeyPress(e, item)"
                                           class="form-control form-control-sm"
                                           autofocus />
                                }
                                else
                                {
                                    <span @onclick='() => StartEditingItem(item, "Amount")'
                                          style="cursor: pointer;">@item.EstimatedAmount.ToString("N2")</span>
                                }
                            </td>
                            <td class="text-center">
                                <input type="checkbox"
                                       checked="@item.IsOptional"
                                       @onchange="(e) => ToggleOptional(item, e.Value is true)" />
                            </td>
                            <td class="text-end">
                                <button class="btn btn-sm btn-outline-danger"
                                        title="Delete item"
                                        @onclick="() => DeleteItem(item)">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>

        <button class="btn btn-primary d-flex align-items-center me-3 gap-2" @onclick="AddItem">
            <i class="fas fa-plus"></i>
            <span>Add</span>
        </button>
    </BodyContent>
</Offcanvas>

@code {
    [Parameter] public Budget? Budget { get; set; }
    [Parameter] public EventCallback OnSaved { get; set; }

    private Offcanvas BudgetCanvas = default!;
    private Budget WorkingBudget = new();

    // Name editing
    private bool IsEditingName { get; set; }
    private string EditableName { get; set; } = "";

    private InlineEditor? NameEditor;

    // Item editing
    private BudgetItem? EditingItem { get; set; }
    private string EditingField { get; set; } = "";
    private string EditableItemName { get; set; } = "";
    private decimal EditableItemAmount { get; set; }

    public async Task ShowAsync(Budget? budget = null)
    {
        if (budget is null)
        {
            WorkingBudget = new Budget
            {
                Name = "",
                CreatedOn = DateOnly.FromDateTime(DateTime.Now),
                Items = new List<BudgetItem>()
            };
            NameEditor?.BeginEdit();
        }
        else
        {
            WorkingBudget = budget;
        }

        await BudgetCanvas.Show();
    }

    private void HandleOffcanvasClosed()
    {
        // Reset editing state, validation, etc.
        WorkingBudget = new Budget { Items = new List<BudgetItem>() };
        IsEditingName = false;
        EditingItem = null;
        EditingField = "";
        EditableName = "";

        StateHasChanged();
    }

    private async Task SaveName(string NewName)
    {
        if (NewName != WorkingBudget.Name)
        {
            WorkingBudget.Name = NewName;
            Db.Budgets.Update(WorkingBudget);
            await Db.SaveChangesAsync();
            await OnSaved.InvokeAsync();
        }
    }

    private async Task SaveItemName(string NewName)
    {
        if (EditingItem != null && NewName != EditingItem.Name)
        {
            EditingItem.Name = NewName;
            Db.BudgetItems.Update(EditingItem);
            await Db.SaveChangesAsync();
            await OnSaved.InvokeAsync();
        }
    }

    private void StartEditingItem(BudgetItem item, string field)
    {
        EditingItem = item;
        EditingField = field;

        if (field == "Name")
            EditableItemName = item.Name;
        else if (field == "Amount")
            EditableItemAmount = item.EstimatedAmount;
    }

    private async Task SaveItem(BudgetItem item)
    {
        if (EditingField == "Name")
            item.Name = EditableItemName;
        else if (EditingField == "Amount")
            item.EstimatedAmount = EditableItemAmount;

        EditingItem = null;
        EditingField = "";

        Db.BudgetItems.Update(item);
        await Db.SaveChangesAsync();
        await OnSaved.InvokeAsync();
    }

    private async Task HandleItemKeyPress(KeyboardEventArgs e, BudgetItem item)
    {
        if (e.Key == "Enter")
            await SaveItem(item);
        else if (e.Key == "Escape")
        {
            EditingItem = null;
            EditingField = "";
            StateHasChanged();
        }
    }

    private async Task ToggleOptional(BudgetItem item, bool newValue)
    {
        item.IsOptional = newValue;
        Db.BudgetItems.Update(item);
        await Db.SaveChangesAsync();
        await OnSaved.InvokeAsync();
    }

    private async Task AddItem()
    {
        var newItem = new BudgetItem
        {
            Name = "New Item",
            EstimatedAmount = 0,
            IsOptional = false,
            CreatedOn = DateOnly.FromDateTime(DateTime.Now),
            BudgetId = WorkingBudget.Id
        };

        Db.BudgetItems.Add(newItem);
        await Db.SaveChangesAsync();

        WorkingBudget.Items.Add(newItem);
        await OnSaved.InvokeAsync();
    }

    private async Task DeleteItem(BudgetItem item)
    {
        Db.BudgetItems.Remove(item);
        await Db.SaveChangesAsync();

        WorkingBudget.Items.Remove(item);
        await OnSaved.InvokeAsync();
    }
}
