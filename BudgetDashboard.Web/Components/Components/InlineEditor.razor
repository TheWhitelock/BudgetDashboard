@typeparam TContext

@if (IsEditing)
{
    <form class="@FormValidationClass" novalidate @onsubmit="HandleSubmitAsync">
        <input @bind="FieldContent"
               @bind:event="oninput"
               @onblur="HandleBlurAsync"
               @onkeydown="HandleKeyPressAsync"
               maxlength="50"
               required
               class="editable-input form-control"
               style="@InputStyle"
               placeholder="@FieldPlaceholder"
               @ref="InputRef" />
    </form>
}
else
{
    @TextContent?.Invoke(() => StartEditing())
}

@code {
    [Parameter] public RenderFragment<Action>? TextContent { get; set; }
    [Parameter] public string FieldContent { get; set; } = string.Empty;
    [Parameter] public string FieldPlaceholder { get; set; } = string.Empty;
    [Parameter] public TContext? Context { get; set; }
    [Parameter] public EventCallback<(string NewValue, TContext? Context)> OnSaved { get; set; }
    [Parameter] public string InputStyle { get; set; } = string.Empty;

    private string OriginalContent { get; set; } = string.Empty;
    private ElementReference InputRef;
    private bool IsEditing { get; set; }
    private bool IsCancelled { get; set; }
    private string FormValidationClass = "";

    public void BeginEdit() => StartEditing();
    public void StopEdit() => StopEditing();

    private async void StartEditing()
    {
        OriginalContent = FieldContent ?? string.Empty;
        IsEditing = true;
        IsCancelled = false;
        await InvokeAsync(StateHasChanged);

        // slight delay so DOM is ready before focusing
        _ = Task.Delay(50).ContinueWith(async _ =>
        {
            try { await InvokeAsync(async () => await InputRef.FocusAsync()); }
            catch { /* ignore focus errors */ }
        });
    }

    private async void StopEditing()
    {
        IsEditing = false;
        FieldContent = OriginalContent;
        FormValidationClass = "";
        await InvokeAsync(StateHasChanged);
    }

    private async Task HandleKeyPressAsync(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            await SaveFieldAsync();
        }
        else if (e.Key == "Escape")
        {
            IsCancelled = true;
            IsEditing = false;
            FieldContent = OriginalContent;
            await InvokeAsync(StateHasChanged);
        }
    }

    private async Task HandleBlurAsync(FocusEventArgs _)
    {
        if (!IsCancelled)
            await SaveFieldAsync();
    }

    private async Task HandleSubmitAsync()
    {
        await SaveFieldAsync();
    }

    private async Task SaveFieldAsync()
    {
        if (IsCancelled)
            return;

        FormValidationClass = "was-validated";

        if (string.IsNullOrWhiteSpace(FieldContent))
        {
            await InvokeAsync(StateHasChanged);
            return;
        }

        FormValidationClass = "";

        if (!string.Equals(FieldContent, OriginalContent, StringComparison.Ordinal))
            await OnSaved.InvokeAsync((FieldContent, Context));

        IsEditing = false;
        await InvokeAsync(StateHasChanged);
    }
}
