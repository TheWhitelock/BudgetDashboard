@using Microsoft.AspNetCore.Components

@* <div class="@OffcanvasCss" tabindex="-1" @onclick:stopPropagation>
    <div class="offcanvas-header">
        <h5 class="offcanvas-title">@Title</h5>
        <button type="button" class="btn-close text-reset" @onclick="Hide"></button>
    </div>
    <div class="offcanvas-body">
        @ChildContent
    </div>
</div> *@

<div class="@OffcanvasCss" tabindex="-1" @onclick:stopPropagation>
    @if (HeaderContent is not null)
    {
        <div class="offcanvas-header">
            @HeaderContent
            <button type="button" class="btn-close text-reset" @onclick="Hide"></button>
        </div>
    }

    <div class="offcanvas-body">
        @BodyContent
    </div>

    @if (FooterContent is not null)
    {
        <div class="offcanvas-footer border-top p-3">
            @FooterContent
        </div>
    }
</div>

@if (BackdropVisible)
{
    <div class="@BackdropCss" @onclick="Hide"></div>
}

@code {
    // Offcanvas content
    /// <summary>
    /// The content displayed in the header section of the offcanvas.
    /// </summary>
    [Parameter] public RenderFragment? HeaderContent { get; set; }

    /// <summary>
    /// The main content inside the offcanvas body.
    /// </summary>
    [Parameter] public RenderFragment? BodyContent { get; set; }

    /// <summary>
    /// Optional footer content displayed at the bottom.
    /// </summary>
    [Parameter] public RenderFragment? FooterContent { get; set; }

    /// <summary>
    /// Determines which side the offcanvas appears from: start, end, top, bottom.
    /// </summary>
    [Parameter] public string Position { get; set; } = "Bottom";

    /// <summary>
    /// The size or height (for bottom/top) of the offcanvas.
    /// </summary>
    [Parameter] public string Size { get; set; } = "md";

    /// <summary>
    /// Tracks visibility of the offcanvas.
    /// </summary>
    [Parameter] public bool IsVisible { get; set; }

    [Parameter] public EventCallback<bool> IsVisibleChanged { get; set; }

    // Compute CSS classes based on position and size
    private string OffcanvasCss => $"offcanvas offcanvas-{Position} offcanvas-{Size} {(AnimationState == "show" ? "show" : (AnimationState == "hide" ? "hiding" : ""))}";

    private string BackdropCss => $"offcanvas-backdrop fade {(BackdropShow ? "show" : "")}";
    //private string OffcanvasStyle => IsVisible ? "visibility: visible;" : "visibility: hidden;";

    // ===== Internal animation state =====
    private bool IsAnimating { get; set; }
    private bool BackdropVisible { get; set; }
    private bool BackdropShow { get; set; }
    private string AnimationState { get; set; } = ""; // "show" or "hide"

    public async Task Show()
    {
        if (IsAnimating) return;
        IsAnimating = true;

        // Step 1: Make backdrop visible in DOM
        BackdropVisible = true;
        BackdropShow = false;
        AnimationState = "show";
        IsVisible = true;
        await IsVisibleChanged.InvokeAsync(true);
        StateHasChanged();

        // Step 2: Wait until it's rendered before adding "show"
        await Task.Delay(10); // slightly more reliable than Task.Yield()
        BackdropShow = true;
        StateHasChanged();

        // Step 3: Wait for transition
        await Task.Delay(300);
        IsAnimating = false;
    }

    public async Task Hide()
    {
        if (IsAnimating) return;
        IsAnimating = true;

        AnimationState = "hide";
        BackdropShow = false;
        await IsVisibleChanged.InvokeAsync(false);
        StateHasChanged();

        await Task.Delay(300); // allow transition to finish

        IsVisible = false;
        BackdropVisible = false;
        AnimationState = "";
        IsAnimating = false;
        StateHasChanged();
    }
}