@page "/dashboard"
@using BudgetDashboard.Data
@using BudgetDashboard.Data.Entities
@using Microsoft.EntityFrameworkCore
@using BudgetDashboard.Web.Components.Shared
@inject BudgetContext Db

<PageTitle>Dashboard</PageTitle>

@if (_budgets is null)
{
    <p><em>Loading...</em></p>
}

else if (_budgets.Count == 0)
{
    <div class="alert alert-info">No budgets yet. Create one below.</div>
}
<div class="row">
    <div class="col-12 mb-3">
        <div class="card total-budget-card">
            <div class="card-body">
                <div class="d-flex align-items-center gap-2 card-title">
                    <span>Total budgeted</span>
                </div>

                <h2 class="card-text text-dark mb-1">
                    € @TotalAmount.ToString("N2")
                </h2>
            </div>
        </div>
    </div>
</div>

<div class="row">
    @if (_budgets is not null)
    {
        @foreach (var budget in _budgets)
        {
            // Responsive column layout:
            // - col-md-12 → Full width on medium screens (<992px)
            // - col-lg-6  → Half width on large screens (≥992px)
            // - col-xl-4  → One-third width on extra-large screens (≥1200px)
            <div class="col-md-12 col-lg-6 col-xl-4 mb-3">
                <BudgetCard Budget="budget" />
            </div>
        }
    }
</div>

<h4>Create new budget</h4>
<div class="input-group mb-3">
    <input name="budgetName" type="text" class="form-control" placeholder="Budget name" @bind="_newBudgetName" @bind:event="oninput" />
    <button class="btn btn-success" @onclick="CreateBudget" disabled="@string.IsNullOrWhiteSpace(_newBudgetName?.Trim())">Add</button>
</div>

@code {
    private List<Budget>? _budgets;
    private string _newBudgetName = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        // Consider moving fetching budgets to a service or state management solution
        // _budgets = await BudgetService.GetBudgetsAsync();

        _budgets = await Db.Budgets
            .Include(b => b.Items)
            .OrderByDescending(b => b.Id)
            .ToListAsync();
    }

    private decimal TotalAmount => _budgets?.Sum(b => b.Items.Sum(i => i.EstimatedAmount)) ?? 0;

    private async Task CreateBudget()
    {
        var name = _newBudgetName.Trim();
        if (string.IsNullOrWhiteSpace(name)) return;

        var budget = new Budget { Name = name };
        Db.Budgets.Add(budget);
        await Db.SaveChangesAsync();

        // If the list of budgets is null, initialize it.
        _budgets ??= new List<Budget>();
        // Add the newly created budget to the list.
        _budgets.Add(budget);
        // Clear the input field.
        _newBudgetName = string.Empty;
    }
}